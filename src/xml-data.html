<script>
xtag.register('xml-data', 
	{
	extends: 'div',
	accessors:
		{
		datafile : {  set : function(val){this._datafile=val;this.load(this,this.onLoad,val);} ,get:function(){return this._datafile;} },
		data : {  set : function(val){this._data=val;this.onData();},get:function() {return this._data;} },
		context :  { set : function(val){this._context=val;this.onContext();},get:function(){return this._context;}},
		template : {set : function(val){this._template=val;this.onTemplate();},get:function(){return this._template;}},
		},
	lifecycle: 
		{
		created: function() 
			{
				this.templateObject = this;
				if(this.attributes.data)
					this._data = this.attributes.data.value;
				if(this.attributes.context)
					this._context = this.attributes.context.value;
				if(this.attributes.template)
					this._template = this.attributes.template.value;
				if(this.attributes.datafile)
					this.datafile = this.attributes.datafile.value;
				else 
					this.onData();
			},
		attributeChanged: function()
			{
				
			}
		},
	methods: 
		{
		onContext : function()
		{
			this.onData();
		},
		onTemplate : function()
		{
			this.onData();
		},
		onLoad : function(obj,datastring)
		{
			obj.data = datastring;
			obj.onData();
		},
		onData : function()
		{
			//console.log("onData "+this.data);
			var xmldoc = this.stringToXML(this.data);
			if(this.template)
				{
				//console.log("template is "+this.template);
				this.templateObject = document.getElementById(this.template);
				//console.log("Found "+this.templateObject);
				this._orgChildren = null;
				}
			if(this.context)
				{
				var children = this._orgChildren;
				if(!children)
					{
					//console.log("Creating new children");
						var content = this.templateObject;
						if(content.content)
							content = content.content;
						children=[];
						for(var i=0; i < content.childNodes.length;i++)
						{
							var cnode = content.childNodes[i];
							children.push(cnode);
							//console.log("Adding "+cnode);
						}
					}
				this._orgChildren=children;
				this.innerHTML = null;
				//console.log("Looking for context "+this.context);
				var cobj = document.evaluate(this.context, xmldoc, null, XPathResult.ORDERED_NODE_SNAPSHOT_TYPE , null );
				//console.log("o:"+cobj+" "+cobj.snapshotLength);
				for(var ci=0; ci < cobj.snapshotLength;ci++)
					{
					var o = cobj.snapshotItem(ci);
					
						//console.log("Children found: "+children.length);
						for(var i=0; i < children.length;i++)
						{
							
							var cnode = children[i];
							//console.log("Adding child "+cnode);
							var newNode = cnode.cloneNode(true);
							
							this.appendChild(newNode);
							this.update(newNode,xmldoc,o,ci,cobj.snapshotLength);
						}
						
					 }
				}
			else 
				{
				this.update(this,xmldoc,xmldoc);
				}
		},
		alterValue : function(valueParent,str, xmldoc, context, itemindex, length)
		{
			if(valueParent.org != null)
			{
				var org = valueParent.org;
				if(org!=null)
					str = org;
			}
			
			valueParent.org = str;
				
			var res=null;
			while(str)
			{
			var index = str.search("{{xml:[^({{)]*?}}");
			if(index != -1)
				{
					var indexEnd = str.substr(index).search("}}");
					var param = str.substr(index+6,indexEnd-6);
					//console.log(str+":"+index+":"+indexEnd+":"+param+" at context "+context);
					
					var val = "";
					if(param=="#index")
						val = itemindex+1;
					else if(param=="#length")
						val = length;
					else
						{
						var rep = document.evaluate(param, context, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null );
						//console.log("evaluate "+param+" on the  doc "+xmldoc+" gives "+rep);
						if(rep.singleNodeValue==null){console.log("Couldn't find path");return;}
						else
							val = rep.singleNodeValue.textContent;
						}
					str = str.replace("{{xml:"+param+"}}",val );
					res = str;
					
				}
			else 
				{
				
				return res;
				}
			}				
			return null;
		},
		update : function(node,xmldoc,context, index,length)
		 {

					
			// Look through all attributes
			//console.log("+NODE "+node.tagName);
			var dic=[];
			if(node.attributes!=undefined)
			{
			for(var i = 0; i <node.attributes.length;i++)
			{
				var attr = node.attributes[i];
				//console.log("ATTR "+attr.name+" = "+attr.value);
				if(attr.value!=null && attr.value != undefined)
				{
				dic[attr.name]=attr;
				var newVal = this.alterValue(attr,attr.value, xmldoc,context,index,length);
				if(newVal!=null)
					attr.value = newVal;
				}
			}
			for(var i = 0; i <node.attributes.length;i++)
			{
				var attr = node.attributes[i];
				
				if(attr.value!=null && attr.value != undefined && attr.name != null)
				{
				
				 var xi = attr.name.indexOf("_shadow");
				 if(xi!= -1)
				 {
				 
					var orgAttrName = attr.name.substr(0,xi); 
					//console.log("_shadow as postfix on "+orgAttrName+" using shadow value "+attr.value);
					var orgAttr = dic[orgAttrName];
					orgAttr.value = attr.value;
				 }
				}
			}
			}
			
			var childCount=0;
			if(node.childNodes!=undefined)
			{
			
			// Look through children
			for (var i = 0; i < node.childNodes.length; i++) {
			var n=node.childNodes[i];
			if(n.tagName!=null)
				{
				this.update(n,xmldoc,context);
				childCount++;
				}
			}
			}
			if(childCount==0)
			{
			//console.log("INNER:"+node.innerHTML);
				var newVal = this.alterValue(node,node.innerHTML, xmldoc,context,index,length);
				if(newVal!=null)
					node.innerHTML = newVal;
			}
			//console.log("-");
		 },
	    stringToXML : function(oString) {
		 //code for IE
		 if (window.ActiveXObject) { 
		 var oXML = new ActiveXObject("Microsoft.XMLDOM"); oXML.loadXML(oString);
		 return oXML;
		 }
		 // code for Chrome, Safari, Firefox, Opera, etc. 
		 else {
		 return (new DOMParser()).parseFromString(oString, "text/xml");
		 }
		},
		load : function(callbackObject,callback,url)
		{
		
			var txtFile = new XMLHttpRequest();
			txtFile.open("GET", url, true);
			txtFile.onreadystatechange = function() {
			  if (txtFile.readyState === 4) {  // Makes sure the document is ready to parse.
				if (txtFile.status === 200) {  // Makes sure it's found the file.
				  callback(callbackObject,txtFile.responseText); 
				 
				}
			  }
			}
			txtFile.send(null);
		}
		
		}
	});

		
	</script>
